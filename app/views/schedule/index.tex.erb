\documentclass[14pt,oneside,a4paper]{memoir}

\pageaiv % A4 page
\pagestyle{empty} % No header/footer

\usepackage{fontspec}
\setmainfont{Times New Roman}
\setsansfont{Arial}
\usepackage{polyglossia}
\newfontfamily\greekfont[Script=Greek]{Times New Roman}
\newfontfamily\greekfontsf[Script=Greek]{Arial}
\newfontfamily\greekfonttt[Script=Greek]{Latin Modern Mono}
\setdefaultlanguage{greek}
\setotherlanguage{english}

%\usepackage[left=2cm,right=2cm,top=2cm,bottom=2cm]{geometry}

\usepackage{hyperref}
\usepackage{color}
\usepackage{ifthen}
\usepackage{refcount}

\setlength{\parindent}{0pt}
\setlength{\parskip}{15pt}
\setlength{\headheight}{0pt}
\setlength{\headsep}{0pt}
\setlength{\topmargin}{0cm}
\setlength{\textheight}{24cm}
\setafterparaskip{0.1ex}

\newenvironment{stayonpage}
{\par\nobreak\vfil\penalty0\vfilneg
\vtop\bgroup}
{\par\xdef\tpd{\the\prevdepth}\egroup
\prevdepth=\tpd}

\newcommand\disappearingrule{%
\par % make sure we end a paragraph
\vskip15pt % space above the rule
\leaders\vrule width \textwidth\vskip0.4pt % rule thickness is 0.4pt
\nointerlineskip % disable interline glue here
\vskip15pt % space below the rule
}

<%= render 'hrule_pass' %>

\begin{document}
<% if Settings.schedule.draft %>
    \begin{center}
      \textbf{Πρόχειρο}

      \textbf{Έκδοση <%= Audited::Audit.last.id %>}
    \end{center}
<% end %>

% hello

<% c_id = 0 %>
<% eidx = 0 %>

<% @events.each_with_index do |event, idx| %>
    <% if event.hidden %>
        <% next %>
    <% elsif (Settings.schedule.hide_unscheduled or event.kind == 'concert') and event.repetitions.empty? %>
        <% next %>
    <% end %>

  <% if event.kind == 'concert' %>
      <% if @concerts and @concerts.include? event %>
          <% next %>
      <% end %>

      <% @concerts = consecutive_concerts(event) %>
      <%= render 'concerts', c_id: c_id %>
      <% c_id += 1 %>
      \immediate\write\tempfile{<%= eidx-1 %>}
      <% next %>
  <% end %>


    \begin{stayonpage}
    <%= render 'event', event: event %>

    \ifcsname hrulefor<%= eidx %> \endcsname
    \else
      \disappearingrule
    \fi
  \end{stayonpage}

  <% if eidx != 0 %>
    {%
        \leavevmode%
        \ifnum\thelastlinepage=\thepage%
        \else%
        \immediate\write\tempfile{<%= eidx-1 %>}%
        \fi%
    }%
  <% end %>
  <% eidx += 1 %>

  \setcounter{lastlinepage}{\thepage}
<% end %>
<% if Settings.schedule.show_unscheduled_concerts %>
    <% @concerts = Event.left_outer_joins(:repetitions).where(repetitions:{id:nil},kind:"concert") %>
    <%= render 'concerts', c_id: c_id %>
<% end %>
\end{document}

\immediate\closeout\tempfile