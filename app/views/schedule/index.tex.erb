\documentclass[14pt,oneside,a4paper]{memoir}

\pageaiv % A4 page
\pagestyle{empty} % No header/footer

\usepackage{fontspec}
\setmainfont{<%= Settings.xelatex.fonts.main %>}
\setsansfont{<%= Settings.xelatex.fonts.sans %>}
\usepackage{polyglossia}
\newfontfamily\greekfont[Script=Greek]{<%= Settings.xelatex.fonts.main %>}
\newfontfamily\greekfontsf[Script=Greek]{<%= Settings.xelatex.fonts.sans %>}
\newfontfamily\greekfonttt[Script=Greek]{<%= Settings.xelatex.fonts.mono %>}
\setdefaultlanguage{greek}
\setotherlanguage{english}

%\usepackage[left=2cm,right=2cm,top=2cm,bottom=2cm]{geometry}

\usepackage[pdftitle={<%= Settings.schedule.title %>}]{hyperref}
\usepackage{color}
\usepackage{xcolor}
\usepackage{ifthen}
\usepackage{refcount}

<% if Settings.schedule.repetition_boxes %>
    \usepackage[left=3.5cm,right=2cm,top=2cm,bottom=2cm,
    marginparwidth=3.1cm, marginparsep=5mm]{geometry}

    \usepackage[skins]{tcolorbox}
    \usepackage{marginnote}
<% end %>

\setlength{\parindent}{0pt}
\setlength{\parskip}{15pt}
\setlength{\headheight}{0pt}
\setlength{\headsep}{0pt}
\setlength{\topmargin}{0cm}
\setlength{\textheight}{24cm}
\setafterparaskip{0.1ex}

\definecolor{linknavy}{rgb}{0,0,0.4}
% Hyperref style configuration
\hypersetup{%
colorlinks=true,
urlcolor=linknavy,
allbordercolors=blue,
}\makeatletter
\Hy@AtBeginDocument{%
\def\@pdfborder{0 0 1}% Overrides border definition set with colorlinks=true
\def\@pdfborderstyle{/S/U/W 1}% Overrides border style set with colorlinks=true
% Hyperlink border style will be underline of width 1pt
}
\makeatother

\newenvironment{stayonpage}
{\par\nobreak\vfil\penalty0\vfilneg
\vtop\bgroup}
{\par\xdef\tpd{\the\prevdepth}\egroup
\prevdepth=\tpd}

\newcommand\disappearingrule{%
\par % make sure we end a paragraph
\vskip15pt % space above the rule
\leaders\vrule width \textwidth\vskip0.4pt % rule thickness is 0.4pt
\nointerlineskip % disable interline glue here
\vskip15pt % space below the rule
}

\newcommand\invisiblerule{%
\par%
\vskip30pt%
}

<%= render 'hrule_pass' %>

\begin{document}
\begin{center}
  \includegraphics[width=\textwidth]{branding_top}
\end{center}

<% if Settings.schedule.draft %>
    \begin{center}
      \textbf{Πρόχειρο}

      \textbf{Έκδοση <%= Audited::Audit.last.id %>}
    \end{center}
<% end %>

% hello

<% c_id = 0 %>
<% eidx = 0 %>

<% @events.each_with_index do |event, idx| %>
    <% if event.hidden %>
        <% next %>
    <% elsif (Settings.schedule.hide_unscheduled or event.kind == 'concert') and event.repetitions.empty? %>
        <% next %>
    <% end %>

  <% if event.kind == 'concert' %>
      <% if @concerts and @concerts.include? event %>
          <% next %>
      <% end %>

      <% @concerts = consecutive_concerts(event) %>
      <%= render 'concerts', c_id: c_id %>
      <% c_id += 1 %>
        \write\tempfile{<%= eidx-1 %> \thepage}%
      <% next %>
  <% end %>


    \begin{stayonpage}
    <%= render 'event', event: event, e_idx: eidx %>

    \ifcsname hrulefor<%= eidx %> \endcsname
      \invisiblerule
    \else
      \disappearingrule
    \fi
  \end{stayonpage}

  \write\tempfile{<%= eidx-1 %> \thepage}%
  <% eidx += 1 %>

  \setcounter{lastlinepage}{\thepage}
<% end %>
<% if Settings.schedule.show_unscheduled_concerts %>
    <% @concerts = Event.left_outer_joins(:repetitions).where(repetitions:{id:nil},kind:"concert") %>
    <%= render 'concerts', c_id: c_id %>
<% end %>

\begin{center}
  \par\vspace*{\fill}
  \includegraphics[width=\textwidth]{branding_bottom}
\end{center}

\end{document}

\immediate\closeout\tempfile
